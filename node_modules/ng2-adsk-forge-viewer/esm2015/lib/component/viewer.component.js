import { __awaiter } from "tslib";
/// <reference types="forge-viewer" />
import { takeUntil } from 'rxjs/operators';
import { ChangeDetectionStrategy, Component, EventEmitter, Input, Output } from '@angular/core';
import { Subject } from 'rxjs';
import { ScriptService } from '../service/script.service';
import { FitToViewEventArgs, FullscreenEventArgs, GeometryLoadedEventArgs, HideEventArgs, IsolateEventArgs, ObjectTreeCreatedEventArgs, ObjectTreeUnavailableEventArgs, ResetEventArgs, SelectionChangedEventArgs, ShowEventArgs, } from '../extensions/extension';
import { BasicExtension } from '../extensions/basic-extension';
export class ViewerComponent {
    constructor(script) {
        this.script = script;
        this.onDocumentChanged = new EventEmitter();
        this.onItemLoaded = new EventEmitter();
        this.onError = new EventEmitter();
        // Viewer events
        this.onFitToView = new EventEmitter();
        this.onFullscreen = new EventEmitter();
        this.onGeometryLoaded = new EventEmitter();
        this.onHide = new EventEmitter();
        this.onIsolate = new EventEmitter();
        this.onObjectTreeCreated = new EventEmitter();
        this.onObjectTreeUnavailable = new EventEmitter();
        this.onReset = new EventEmitter();
        this.onSelectionChanged = new EventEmitter();
        this.onShow = new EventEmitter();
        // Debugging
        this.showDebugMessages = false;
        this._viewerOptions = null;
        this.viewerInitialized = false;
        this.unsubscribe = new Subject();
        this.containerId = this.getDivName();
    }
    /**
     * Helper to allow callers to specify documentId with or without the required urn: prefix
     */
    static verifyUrn(documentId) {
        return (documentId.startsWith('urn:')) ? documentId : `urn:${documentId}`;
    }
    set viewerOptions(options) {
        if (!this.viewerInitialized && options) {
            this._viewerOptions = options;
            void this.initialiseViewer();
        }
    }
    get viewerOptions() {
        return this._viewerOptions;
    }
    ngOnDestroy() {
        this.unregisterBasicExtension();
        if (this.viewer) {
            this.viewer.tearDown();
            this.viewer.uninitialize();
        }
        this.viewer = null;
        this.viewerInitialized = false;
        this.unsubscribe.next();
        this.unsubscribe.complete();
    }
    /**
     * Helper method to get some default viewer options
     */
    getDefaultViewerOptions(onViewerInitialized, getAccessToken) {
        return {
            initializerOptions: {
                env: 'AutodeskProduction',
                getAccessToken,
                api: 'derivativeV2',
            },
            onViewerInitialized,
        };
    }
    /**
     * Get a reference to the current 3D viewer
     */
    get Viewer3D() {
        return this.viewer;
    }
    /**
     * Get the document urn that has been loaded
     */
    get DocumentId() {
        return this.documentId;
    }
    /**
     * Set the document urn, which triggers the viewer to load the document
     */
    set DocumentId(value) {
        this.documentId = value;
        this.loadModel(this.documentId);
    }
    /**
     * Get the container element
     */
    get Container() {
        return document.getElementById(this.containerId);
    }
    /**
     * Get the id assigned to the viewer
     */
    get ContainerId() {
        return this.containerId;
    }
    get basicExtension() {
        return this.basicExt;
    }
    get extensionEvents() {
        if (this.basicExt) {
            return this.basicExt.viewerEvents;
        }
    }
    loadDocumentNode(document, bubbleNode, options) {
        return this.viewer.loadDocumentNode(document, bubbleNode, options);
    }
    /**
     * We don't bundle Autodesk's scripts with the component, and we don't really want users to have
     * to add the scripts to their index.html pages. So we'll load them when required.
     */
    loadScripts() {
        const version = this.viewerOptions.version || '7.*';
        const url = `https://developer.api.autodesk.com/modelderivative/v2/viewers/${version}/viewer3D.min.js`;
        return this.script.load(url)
            .then((data) => {
            this.log('script loaded ', data);
        })
            .catch(error => this.error(error));
    }
    /**
     * Initialises the viewer
     */
    initialiseViewer() {
        return __awaiter(this, void 0, void 0, function* () {
            // Load scripts first
            yield this.loadScripts();
            if (this.viewerOptions.onViewerScriptsLoaded)
                this.viewerOptions.onViewerScriptsLoaded();
            // Check if the viewer has already been initialised - this isn't the nicest, but we've set the env in our
            // options above so we at least know that it was us who did this!
            if (!Autodesk.Viewing.Private.env) {
                Autodesk.Viewing.Initializer(this.viewerOptions.initializerOptions, () => {
                    this.initialized();
                });
            }
            else {
                // We need to give an initialised viewing application a tick to allow the DOM element
                // to be established before we re-draw
                setTimeout(() => {
                    this.initialized();
                });
            }
        });
    }
    initialized() {
        var _a, _b;
        // Register an extension to help us raise events
        const extName = this.registerBasicExtension();
        const config = this.addBasicExtensionConfig(extName);
        // Support large models
        if (this.viewerOptions.enableMemoryManagement) {
            config.loaderExtensions = { svf: 'Autodesk.MemoryLimited' };
        }
        // Create a new viewer
        if (this.viewerOptions.headlessViewer) {
            this.viewer = new Autodesk.Viewing.Viewer3D(this.Container, config);
        }
        else {
            this.viewer = new Autodesk.Viewing.GuiViewer3D(this.Container, config);
        }
        // set a document url if environment set to Local
        let url;
        if (((_a = this.viewerOptions.initializerOptions) === null || _a === void 0 ? void 0 : _a.env) === 'Local') {
            url = (_b = this.viewerOptions.initializerOptions) === null || _b === void 0 ? void 0 : _b.document;
        }
        // Start the viewer
        this.viewer.start(url);
        // Viewer is ready - scripts are loaded and we've create a new viewing application
        this.viewerInitialized = true;
        this.viewerOptions.onViewerInitialized({ viewerComponent: this, viewer: this.viewer });
    }
    /**
     * Loads a model in to the viewer via it's urn
     */
    loadModel(documentId) {
        if (!documentId) {
            return;
        }
        // Add urn: to the beginning of document id if needed
        Autodesk.Viewing.Document.load(ViewerComponent.verifyUrn(documentId), this.onDocumentLoadSuccess.bind(this), this.onDocumentLoadFailure.bind(this));
    }
    /**
     * Document successfully loaded
     */
    onDocumentLoadSuccess(document) {
        if (!document.getRoot())
            return;
        // Emit an event so the caller can do something
        // TODO: config option to specify which viewable to display (how?)
        this.onDocumentChanged.emit({ document, viewerComponent: this, viewer: this.viewer });
        if (this.viewerOptions.showFirstViewable === undefined || this.viewerOptions.showFirstViewable) {
            let model = document.getRoot().getDefaultGeometry();
            if (!model) {
                const allModels = document.getRoot().search({ type: 'geometry' });
                model = allModels[0];
            }
            void this.viewer.loadDocumentNode(document, model, undefined);
        }
    }
    /**
     * Failed to load document
     */
    onDocumentLoadFailure(errorCode) {
        this.error('onDocumentLoadFailure() - errorCode:' + errorCode);
        this.onError.emit(errorCode);
    }
    /**
     * Register our BasicExtension with the Forge Viewer
     */
    registerBasicExtension() {
        BasicExtension.registerExtension(BasicExtension.extensionName, this.extensionLoaded.bind(this));
        return BasicExtension.extensionName;
    }
    /**
     * Subscript to BasicExtension events when the extension has been
     * succesfully loaded by the viewer.
     */
    extensionLoaded(ext) {
        this.basicExt = ext;
        ext.viewerEvents
            .pipe(takeUntil(this.unsubscribe))
            .subscribe((item) => {
            this.log(item);
            if (item instanceof FitToViewEventArgs) {
                this.onFitToView.emit(item);
            }
            else if (item instanceof FullscreenEventArgs) {
                this.onFullscreen.emit(item);
            }
            else if (item instanceof GeometryLoadedEventArgs) {
                this.onGeometryLoaded.emit(item);
            }
            else if (item instanceof HideEventArgs) {
                this.onHide.emit(item);
            }
            else if (item instanceof IsolateEventArgs) {
                this.onIsolate.emit(item);
            }
            else if (item instanceof ObjectTreeCreatedEventArgs) {
                this.onObjectTreeCreated.emit(item);
            }
            else if (item instanceof ObjectTreeUnavailableEventArgs) {
                this.onObjectTreeUnavailable.emit(item);
            }
            else if (item instanceof ResetEventArgs) {
                this.onReset.emit(item);
            }
            else if (item instanceof SelectionChangedEventArgs) {
                this.onSelectionChanged.emit(item);
            }
            else if (item instanceof ShowEventArgs) {
                this.onShow.emit(item);
            }
        });
    }
    unregisterBasicExtension() {
        BasicExtension.unregisterExtension(BasicExtension.extensionName);
        this.basicExt = null;
    }
    /**
     * Add list of extensions to the viewer config that has been provided
     * The allows the user to register their own extensions.
     */
    addBasicExtensionConfig(extName) {
        const config = Object.assign({}, this.viewerOptions.viewerConfig, { extensions: [] });
        // We will always load our basic extension with any others specified by the caller
        if (this.viewerOptions.viewerConfig && this.viewerOptions.viewerConfig.extensions) {
            config.extensions = [...this.viewerOptions.viewerConfig.extensions, extName];
        }
        else {
            config.extensions = [extName];
        }
        return config;
    }
    log(message, ...optionalParams) {
        if (!this.showDebugMessages)
            return;
        console.log(message, optionalParams);
    }
    error(message, ...optionalParams) {
        if (!this.showDebugMessages)
            return;
        console.error(message, optionalParams);
    }
    getDivName() {
        const S4 = () => {
            // tslint:disable-next-line:no-bitwise
            return (((1 + Math.random()) * 0x10000) | 0).toString(16).substring(1);
        };
        const guid = (S4() + S4() + '-' + S4() + '-' + S4() + '-' + S4() + '-' + S4() + S4() + S4());
        return `viewer_${guid}`;
    }
}
ViewerComponent.decorators = [
    { type: Component, args: [{
                selector: 'adsk-forge-viewer',
                template: "<div [id]=\"containerId\" class=\"forge-viewer-container\"></div>\n",
                changeDetection: ChangeDetectionStrategy.OnPush,
                styles: ["@import url(\"https://developer.api.autodesk.com/modelderivative/v2/viewers/7.*/style.min.css\");"]
            },] }
];
/** @nocollapse */
ViewerComponent.ctorParameters = () => [
    { type: ScriptService }
];
ViewerComponent.propDecorators = {
    onDocumentChanged: [{ type: Output }],
    onItemLoaded: [{ type: Output }],
    onError: [{ type: Output }],
    onFitToView: [{ type: Output }],
    onFullscreen: [{ type: Output }],
    onGeometryLoaded: [{ type: Output }],
    onHide: [{ type: Output }],
    onIsolate: [{ type: Output }],
    onObjectTreeCreated: [{ type: Output }],
    onObjectTreeUnavailable: [{ type: Output }],
    onReset: [{ type: Output }],
    onSelectionChanged: [{ type: Output }],
    onShow: [{ type: Output }],
    showDebugMessages: [{ type: Input }],
    viewerOptions: [{ type: Input }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmlld2VyLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL25nMi1hZHNrLWZvcmdlLXZpZXdlci9zcmMvbGliL2NvbXBvbmVudC92aWV3ZXIuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxzQ0FBc0M7QUFDdEMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBSTNDLE9BQU8sRUFBRSx1QkFBdUIsRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLEtBQUssRUFDOUQsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2hDLE9BQU8sRUFBRSxPQUFPLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFFM0MsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQzFELE9BQU8sRUFDTCxrQkFBa0IsRUFDbEIsbUJBQW1CLEVBQ25CLHVCQUF1QixFQUN2QixhQUFhLEVBQ2IsZ0JBQWdCLEVBQ2hCLDBCQUEwQixFQUMxQiw4QkFBOEIsRUFBRSxjQUFjLEVBQzlDLHlCQUF5QixFQUN6QixhQUFhLEdBRWQsTUFBTSx5QkFBeUIsQ0FBQztBQUNqQyxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFxQy9ELE1BQU0sT0FBTyxlQUFlO0lBb0MxQixZQUFvQixNQUFxQjtRQUFyQixXQUFNLEdBQU4sTUFBTSxDQUFlO1FBakN4QixzQkFBaUIsR0FBRyxJQUFJLFlBQVksRUFBd0IsQ0FBQztRQUM3RCxpQkFBWSxHQUFHLElBQUksWUFBWSxFQUFtQixDQUFDO1FBQ25ELFlBQU8sR0FBRyxJQUFJLFlBQVksRUFBK0IsQ0FBQztRQUUzRSxnQkFBZ0I7UUFDQyxnQkFBVyxHQUFHLElBQUksWUFBWSxFQUFzQixDQUFDO1FBQ3JELGlCQUFZLEdBQUcsSUFBSSxZQUFZLEVBQXVCLENBQUM7UUFDdkQscUJBQWdCLEdBQUcsSUFBSSxZQUFZLEVB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QyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDekUsQ0FBQyxDQUFDO1FBRUYsTUFBTSxJQUFJLEdBQUcsQ0FBQyxFQUFFLEVBQUUsR0FBRyxFQUFFLEVBQUUsR0FBRyxHQUFHLEdBQUcsRUFBRSxFQUFFLEdBQUcsR0FBRyxHQUFHLEVBQUUsRUFBRSxHQUFHLEdBQUcsR0FBRyxFQUFFLEVBQUUsR0FBRyxHQUFHLEdBQUcsRUFBRSxFQUFFLEdBQUcsRUFBRSxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUM3RixPQUFPLFVBQVUsSUFBSSxFQUFFLENBQUM7SUFDMUIsQ0FBQzs7O1lBcFZGLFNBQVMsU0FBQztnQkFDVCxRQUFRLEVBQUUsbUJBQW1CO2dCQUM3QiwrRUFBc0M7Z0JBRXRDLGVBQWUsRUFBRSx1QkFBdUIsQ0FBQyxNQUFNOzthQUNoRDs7OztZQWpEUSxhQUFhOzs7Z0NBcURuQixNQUFNOzJCQUNOLE1BQU07c0JBQ04sTUFBTTswQkFHTixNQUFNOzJCQUNOLE1BQU07K0JBQ04sTUFBTTtxQkFDTixNQUFNO3dCQUNOLE1BQU07a0NBQ04sTUFBTTtzQ0FDTixNQUFNO3NCQUNOLE1BQU07aUNBQ04sTUFBTTtxQkFDTixNQUFNO2dDQUdOLEtBQUs7NEJBb0JMLEtBQUsiLCJzb3VyY2VzQ29udGVudCI6WyIvLy8gPHJlZmVyZW5jZSB0eXBlcz1cImZvcmdlLXZpZXdlclwiIC8+XG5pbXBvcnQgeyB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmRlY2xhcmUgY29uc3QgQXV0b2Rlc2s6IGFueTtcblxuaW1wb3J0IHsgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksIENvbXBvbmVudCwgRXZlbnRFbWl0dGVyLCBJbnB1dCwgT25EZXN0cm95LFxuICBPdXRwdXQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IFN1YmplY3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHsgU2NyaXB0U2VydmljZSB9IGZyb20gJy4uL3NlcnZpY2Uvc2NyaXB0LnNlcnZpY2UnO1xuaW1wb3J0IHtcbiAgRml0VG9WaWV3RXZlbnRBcmdzLFxuICBGdWxsc2NyZWVuRXZlbnRBcmdzLFxuICBHZW9tZXRyeUxvYWRlZEV2ZW50QXJncyxcbiAgSGlkZUV2ZW50QXJncyxcbiAgSXNvbGF0ZUV2ZW50QXJncyxcbiAgT2JqZWN0VHJlZUNyZWF0ZWRFdmVudEFyZ3MsXG4gIE9iamVjdFRyZWVVbmF2YWlsYWJsZUV2ZW50QXJncywgUmVzZXRFdmVudEFyZ3MsXG4gIFNlbGVjdGlvbkNoYW5nZWRFdmVudEFyZ3MsXG4gIFNob3dFdmVudEFyZ3MsXG4gIFZpZXdlckV2ZW50QXJncyxcbn0gZnJvbSAnLi4vZXh0ZW5zaW9ucy9leHRlbnNpb24nO1xuaW1wb3J0IHsgQmFzaWNFeHRlbnNpb24gfSBmcm9tICcuLi9leHRlbnNpb25zL2Jhc2ljLWV4dGVuc2lvbic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgRG9jdW1lbnRDaGFuZ2VkRXZlbnQge1xuICBkb2N1bWVudDogQXV0b2Rlc2suVmlld2luZy5Eb2N1bWVudDtcbiAgdmlld2VyQ29tcG9uZW50OiBWaWV3ZXJDb21wb25lbnQ7XG4gIHZpZXdlcjogQXV0b2Rlc2suVmlld2luZy5WaWV3ZXIzRDtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBJdGVtTG9hZGVkRXZlbnQge1xuICBpdGVtOiBBdXRvZGVzay5WaWV3aW5nLlZpZXdlckl0ZW07XG4gIHZpZXdlcjogQXV0b2Rlc2suVmlld2luZy5WaWV3ZXIzRDtcbiAgdmlld2VyQ29tcG9uZW50OiBWaWV3ZXJDb21wb25lbnQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVmlld2VySW5pdGlhbGl6ZWRFdmVudCB7XG4gIHZpZXdlckNvbXBvbmVudDogVmlld2VyQ29tcG9uZW50O1xuICB2aWV3ZXI6IEF1dG9kZXNrLlZpZXdpbmcuVmlld2VyM0Q7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgVmlld2VyT3B0aW9ucyB7XG4gIGluaXRpYWxpemVyT3B0aW9uczogQXV0b2Rlc2suVmlld2luZy5Jbml0aWFsaXplck9wdGlvbnM7XG4gIHZpZXdlckNvbmZpZz86IEF1dG9kZXNrLlZpZXdpbmcuVmlld2VyQ29uZmlnO1xuICBoZWFkbGVzc1ZpZXdlcj86IGJvb2xlYW47XG4gIHNob3dGaXJzdFZpZXdhYmxlPzogYm9vbGVhbjtcbiAgZW5hYmxlTWVtb3J5TWFuYWdlbWVudD86IGJvb2xlYW47XG4gIG9uVmlld2VyU2NyaXB0c0xvYWRlZD86ICgpID0+IHZvaWQ7XG4gIG9uVmlld2VySW5pdGlhbGl6ZWQ6IChhcmdzOiBWaWV3ZXJJbml0aWFsaXplZEV2ZW50KSA9PiB2b2lkO1xuICB2ZXJzaW9uPzogc3RyaW5nIHwgbnVtYmVyO1xufVxuXG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2Fkc2stZm9yZ2Utdmlld2VyJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3ZpZXdlci5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL3ZpZXdlci5jb21wb25lbnQuY3NzJ10sXG4gIGNoYW5nZURldGVjdGlvbjogQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3kuT25QdXNoLFxufSlcbmV4cG9ydCBjbGFzcyBWaWV3ZXJDb21wb25lbnQgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xuICBwdWJsaWMgY29udGFpbmVySWQ6IHN0cmluZztcblxuICBAT3V0cHV0KCkgcHVibGljIG9uRG9jdW1lbnRDaGFuZ2VkID0gbmV3IEV2ZW50RW1pdHRlcjxEb2N1bWVudENoYW5nZWRFdmVudD4oKTtcbiAgQE91dHB1dCgpIHB1YmxpYyBvbkl0ZW1Mb2FkZWQgPSBuZXcgRXZlbnRFbWl0dGVyPEl0ZW1Mb2FkZWRFdmVudD4oKTtcbiAgQE91dHB1dCgpIHB1YmxpYyBvbkVycm9yID0gbmV3IEV2ZW50RW1pdHRlcjxBdXRvZGVzay5WaWV3aW5nLkVycm9yQ29kZXM+KCk7XG5cbiAgLy8gVmlld2VyIGV2ZW50c1xuICBAT3V0cHV0KCkgcHVibGljIG9uRml0VG9WaWV3ID0gbmV3IEV2ZW50RW1pdHRlcjxGaXRUb1ZpZXdFdmVudEFyZ3M+KCk7XG4gIEBPdXRwdXQoKSBwdWJsaWMgb25GdWxsc2NyZWVuID0gbmV3IEV2ZW50RW1pdHRlcjxGdWxsc2NyZWVuRXZlbnRBcmdzPigpO1xuICBAT3V0cHV0KCkgcHVibGljIG9uR2VvbWV0cnlMb2FkZWQgPSBuZXcgRXZlbnRFbWl0dGVyPEdlb21ldHJ5TG9hZGVkRXZlbnRBcmdzPigpO1xuICBAT3V0cHV0KCkgcHVibGljIG9uSGlkZSA9IG5ldyBFdmVudEVtaXR0ZXI8SGlkZUV2ZW50QXJncz4oKTtcbiAgQE91dHB1dCgpIHB1YmxpYyBvbklzb2xhdGUgPSBuZXcgRXZlbnRFbWl0dGVyPElzb2xhdGVFdmVudEFyZ3M+KCk7XG4gIEBPdXRwdXQoKSBwdWJsaWMgb25PYmplY3RUcmVlQ3JlYXRlZCA9IG5ldyBFdmVudEVtaXR0ZXI8T2JqZWN0VHJlZUNyZWF0ZWRFdmVudEFyZ3M+KCk7XG4gIEBPdXRwdXQoKSBwdWJsaWMgb25PYmplY3RUcmVlVW5hdmFpbGFibGUgPSBuZXcgRXZlbnRFbWl0dGVyPE9iamVjdFRyZWVVbmF2YWlsYWJsZUV2ZW50QXJncz4oKTtcbiAgQE91dHB1dCgpIHB1YmxpYyBvblJlc2V0ID0gbmV3IEV2ZW50RW1pdHRlcjxSZXNldEV2ZW50QXJncz4oKTtcbiAgQE91dHB1dCgpIHB1YmxpYyBvblNlbGVjdGlvbkNoYW5nZWQgPSBuZXcgRXZlbnRFbWl0dGVyPFNlbGVjdGlvbkNoYW5nZWRFdmVudEFyZ3M+KCk7XG4gIEBPdXRwdXQoKSBwdWJsaWMgb25TaG93ID0gbmV3IEV2ZW50RW1pdHRlcjxTaG93RXZlbnRBcmdzPigpO1xuXG4gIC8vIERlYnVnZ2luZ1xuICBASW5wdXQoKSBwdWJsaWMgc2hvd0RlYnVnTWVzc2FnZXMgPSBmYWxzZTtcblxuICBwcml2YXRlIF92aWV3ZXJPcHRpb25zOiBWaWV3ZXJPcHRpb25zID0gbnVsbDtcbiAgcHJpdmF0ZSB2aWV3ZXJJbml0aWFsaXplZCA9IGZhbHNlO1xuICBwcml2YXRlIHZpZXdlcjogQXV0b2Rlc2suVmlld2luZy5WaWV3ZXIzRDtcbiAgcHJpdmF0ZSBkb2N1bWVudElkOiBzdHJpbmc7XG4gIHByaXZhdGUgdW5zdWJzY3JpYmU6IFN1YmplY3Q8Ym9vbGVhbj4gPSBuZXcgU3ViamVjdCgpO1xuICBwcml2YXRlIGJhc2ljRXh0OiBCYXNpY0V4dGVuc2lvbjtcblxuICAvKipcbiAgICogSGVscGVyIHRvIGFsbG93IGNhbGxlcnMgdG8gc3BlY2lmeSBkb2N1bWVudElkIHdpdGggb3Igd2l0aG91dCB0aGUgcmVxdWlyZWQgdXJuOiBwcmVmaXhcbiAgICovXG4gIHByaXZhdGUgc3RhdGljIHZlcmlmeVVybihkb2N1bWVudElkOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiAoZG9jdW1lbnRJZC5zdGFydHNXaXRoKCd1cm46JykpID8gZG9jdW1lbnRJZCA6IGB1cm46JHtkb2N1bWVudElkfWA7XG4gIH1cblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHNjcmlwdDogU2NyaXB0U2VydmljZSkge1xuICAgIHRoaXMuY29udGFpbmVySWQgPSB0aGlzLmdldERpdk5hbWUoKTtcbiAgfVxuXG4gIEBJbnB1dCgpIHB1YmxpYyBzZXQgdmlld2VyT3B0aW9ucyhvcHRpb25zOiBWaWV3ZXJPcHRpb25zKSB7XG4gICAgaWYgKCF0aGlzLnZpZXdlckluaXRpYWxpemVkICYmIG9wdGlvbnMpIHtcbiAgICAgIHRoaXMuX3ZpZXdlck9wdGlvbnMgPSBvcHRpb25zO1xuICAgICAgdm9pZCB0aGlzLmluaXRpYWxpc2VWaWV3ZXIoKTtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgZ2V0IHZpZXdlck9wdGlvbnMoKSB7XG4gICAgcmV0dXJuIHRoaXMuX3ZpZXdlck9wdGlvbnM7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLnVucmVnaXN0ZXJCYXNpY0V4dGVuc2lvbigpO1xuXG4gICAgaWYgKHRoaXMudmlld2VyKSB7XG4gICAgICB0aGlzLnZpZXdlci50ZWFyRG93bigpO1xuICAgICAgdGhpcy52aWV3ZXIudW5pbml0aWFsaXplKCk7XG4gICAgfVxuXG4gICAgdGhpcy52aWV3ZXIgPSBudWxsO1xuICAgIHRoaXMudmlld2VySW5pdGlhbGl6ZWQgPSBmYWxzZTtcblxuICAgIHRoaXMudW5zdWJzY3JpYmUubmV4dCgpO1xuICAgIHRoaXMudW5zdWJzY3JpYmUuY29tcGxldGUoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBIZWxwZXIgbWV0aG9kIHRvIGdldCBzb21lIGRlZmF1bHQgdmlld2VyIG9wdGlvbnNcbiAgICovXG4gIHB1YmxpYyBnZXREZWZhdWx0Vmlld2VyT3B0aW9ucyhcbiAgICBvblZpZXdlckluaXRpYWxpemVkOiAoYXJnczogVmlld2VySW5pdGlhbGl6ZWRFdmVudCkgPT4gdm9pZCxcbiAgICBnZXRBY2Nlc3NUb2tlbjogKG9uR2V0QWNjZXNzVG9rZW46ICh0b2tlbjogc3RyaW5nLCBleHBpcmU6IG51bWJlcikgPT4gdm9pZCkgPT4gdm9pZCxcbiAgKTogVmlld2VyT3B0aW9ucyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGluaXRpYWxpemVyT3B0aW9uczoge1xuICAgICAgICBlbnY6ICdBdXRvZGVza1Byb2R1Y3Rpb24nLFxuICAgICAgICBnZXRBY2Nlc3NUb2tlbixcbiAgICAgICAgYXBpOiAnZGVyaXZhdGl2ZVYyJyxcbiAgICAgIH0sXG4gICAgICBvblZpZXdlckluaXRpYWxpemVkLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogR2V0IGEgcmVmZXJlbmNlIHRvIHRoZSBjdXJyZW50IDNEIHZpZXdlclxuICAgKi9cbiAgcHVibGljIGdldCBWaWV3ZXIzRCgpOiBBdXRvZGVzay5WaWV3aW5nLlZpZXdlcjNEIHtcbiAgICByZXR1cm4gdGhpcy52aWV3ZXI7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSBkb2N1bWVudCB1cm4gdGhhdCBoYXMgYmVlbiBsb2FkZWRcbiAgICovXG4gIHB1YmxpYyBnZXQgRG9jdW1lbnRJZCgpIHtcbiAgICByZXR1cm4gdGhpcy5kb2N1bWVudElkO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCB0aGUgZG9jdW1lbnQgdXJuLCB3aGljaCB0cmlnZ2VycyB0aGUgdmlld2VyIHRvIGxvYWQgdGhlIGRvY3VtZW50XG4gICAqL1xuICBwdWJsaWMgc2V0IERvY3VtZW50SWQodmFsdWU6IHN0cmluZykge1xuICAgIHRoaXMuZG9jdW1lbnRJZCA9IHZhbHVlO1xuICAgIHRoaXMubG9hZE1vZGVsKHRoaXMuZG9jdW1lbnRJZCk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSBjb250YWluZXIgZWxlbWVudFxuICAgKi9cbiAgcHVibGljIGdldCBDb250YWluZXIoKTogSFRNTEVsZW1lbnQge1xuICAgIHJldHVybiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0aGlzLmNvbnRhaW5lcklkKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIGlkIGFzc2lnbmVkIHRvIHRoZSB2aWV3ZXJcbiAgICovXG4gIHB1YmxpYyBnZXQgQ29udGFpbmVySWQoKSB7XG4gICAgcmV0dXJuIHRoaXMuY29udGFpbmVySWQ7XG4gIH1cblxuICBwdWJsaWMgZ2V0IGJhc2ljRXh0ZW5zaW9uKCkge1xuICAgIHJldHVybiB0aGlzLmJhc2ljRXh0O1xuICB9XG5cbiAgcHVibGljIGdldCBleHRlbnNpb25FdmVudHMoKTogT2JzZXJ2YWJsZTxWaWV3ZXJFdmVudEFyZ3M+IHwgbnVsbCB7XG4gICAgaWYgKHRoaXMuYmFzaWNFeHQpIHtcbiAgICAgIHJldHVybiB0aGlzLmJhc2ljRXh0LnZpZXdlckV2ZW50cztcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgbG9hZERvY3VtZW50Tm9kZShkb2N1bWVudDogQXV0b2Rlc2suVmlld2luZy5Eb2N1bWVudCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgYnViYmxlTm9kZTogQXV0b2Rlc2suVmlld2luZy5CdWJibGVOb2RlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICBvcHRpb25zPzogb2JqZWN0KTogUHJvbWlzZTxBdXRvZGVzay5WaWV3aW5nLk1vZGVsPiB7XG4gICAgcmV0dXJuIHRoaXMudmlld2VyLmxvYWREb2N1bWVudE5vZGUoZG9jdW1lbnQsIGJ1YmJsZU5vZGUsIG9wdGlvbnMpO1xuICB9XG5cbiAgLyoqXG4gICAqIFdlIGRvbid0IGJ1bmRsZSBBdXRvZGVzaydzIHNjcmlwdHMgd2l0aCB0aGUgY29tcG9uZW50LCBhbmQgd2UgZG9uJ3QgcmVhbGx5IHdhbnQgdXNlcnMgdG8gaGF2ZVxuICAgKiB0byBhZGQgdGhlIHNjcmlwdHMgdG8gdGhlaXIgaW5kZXguaHRtbCBwYWdlcy4gU28gd2UnbGwgbG9hZCB0aGVtIHdoZW4gcmVxdWlyZWQuXG4gICAqL1xuICBwcml2YXRlIGxvYWRTY3JpcHRzKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IHZlcnNpb24gPSB0aGlzLnZpZXdlck9wdGlvbnMudmVyc2lvbiB8fCAnNy4qJztcbiAgICBjb25zdCB1cmwgPSBgaHR0cHM6Ly9kZXZlbG9wZXIuYXBpLmF1dG9kZXNrLmNvbS9tb2RlbGRlcml2YXRpdmUvdjIvdmlld2Vycy8ke3ZlcnNpb259L3ZpZXdlcjNELm1pbi5qc2A7XG4gICAgcmV0dXJuIHRoaXMuc2NyaXB0LmxvYWQoXG4gICAgICB1cmwsXG4gICAgKVxuICAgICAgLnRoZW4oKGRhdGEpID0+IHtcbiAgICAgICAgdGhpcy5sb2coJ3NjcmlwdCBsb2FkZWQgJywgZGF0YSk7XG4gICAgICB9KVxuICAgICAgLmNhdGNoKGVycm9yID0+IHRoaXMuZXJyb3IoZXJyb3IpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbml0aWFsaXNlcyB0aGUgdmlld2VyXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGluaXRpYWxpc2VWaWV3ZXIoKSB7XG4gICAgLy8gTG9hZCBzY3JpcHRzIGZpcnN0XG4gICAgYXdhaXQgdGhpcy5sb2FkU2NyaXB0cygpO1xuICAgIGlmICh0aGlzLnZpZXdlck9wdGlvbnMub25WaWV3ZXJTY3JpcHRzTG9hZGVkKSB0aGlzLnZpZXdlck9wdGlvbnMub25WaWV3ZXJTY3JpcHRzTG9hZGVkKCk7XG5cbiAgICAvLyBDaGVjayBpZiB0aGUgdmlld2VyIGhhcyBhbHJlYWR5IGJlZW4gaW5pdGlhbGlzZWQgLSB0aGlzIGlzbid0IHRoZSBuaWNlc3QsIGJ1dCB3ZSd2ZSBzZXQgdGhlIGVudiBpbiBvdXJcbiAgICAvLyBvcHRpb25zIGFib3ZlIHNvIHdlIGF0IGxlYXN0IGtub3cgdGhhdCBpdCB3YXMgdXMgd2hvIGRpZCB0aGlzIVxuICAgIGlmICghQXV0b2Rlc2suVmlld2luZy5Qcml2YXRlLmVudikge1xuICAgICAgQXV0b2Rlc2suVmlld2luZy5Jbml0aWFsaXplcih0aGlzLnZpZXdlck9wdGlvbnMuaW5pdGlhbGl6ZXJPcHRpb25zLCAoKSA9PiB7XG4gICAgICAgIHRoaXMuaW5pdGlhbGl6ZWQoKTtcbiAgICAgIH0pO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBXZSBuZWVkIHRvIGdpdmUgYW4gaW5pdGlhbGlzZWQgdmlld2luZyBhcHBsaWNhdGlvbiBhIHRpY2sgdG8gYWxsb3cgdGhlIERPTSBlbGVtZW50XG4gICAgICAvLyB0byBiZSBlc3RhYmxpc2hlZCBiZWZvcmUgd2UgcmUtZHJhd1xuICAgICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgIHRoaXMuaW5pdGlhbGl6ZWQoKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaW5pdGlhbGl6ZWQoKSB7XG4gICAgLy8gUmVnaXN0ZXIgYW4gZXh0ZW5zaW9uIHRvIGhlbHAgdXMgcmFpc2UgZXZlbnRzXG4gICAgY29uc3QgZXh0TmFtZSA9IHRoaXMucmVnaXN0ZXJCYXNpY0V4dGVuc2lvbigpO1xuICAgIGNvbnN0IGNvbmZpZyA9IHRoaXMuYWRkQmFzaWNFeHRlbnNpb25Db25maWcoZXh0TmFtZSk7XG5cbiAgICAvLyBTdXBwb3J0IGxhcmdlIG1vZGVsc1xuICAgIGlmICh0aGlzLnZpZXdlck9wdGlvbnMuZW5hYmxlTWVtb3J5TWFuYWdlbWVudCkge1xuICAgICAgY29uZmlnLmxvYWRlckV4dGVuc2lvbnMgPSB7IHN2ZjogJ0F1dG9kZXNrLk1lbW9yeUxpbWl0ZWQnIH07XG4gICAgfVxuXG4gICAgLy8gQ3JlYXRlIGEgbmV3IHZpZXdlclxuICAgIGlmICh0aGlzLnZpZXdlck9wdGlvbnMuaGVhZGxlc3NWaWV3ZXIpIHtcbiAgICAgIHRoaXMudmlld2VyID0gbmV3IEF1dG9kZXNrLlZpZXdpbmcuVmlld2VyM0QodGhpcy5Db250YWluZXIsIGNvbmZpZyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudmlld2VyID0gbmV3IEF1dG9kZXNrLlZpZXdpbmcuR3VpVmlld2VyM0QodGhpcy5Db250YWluZXIsIGNvbmZpZyk7XG4gICAgfVxuXG4gICAgLy8gc2V0IGEgZG9jdW1lbnQgdXJsIGlmIGVudmlyb25tZW50IHNldCB0byBMb2NhbFxuICAgIGxldCB1cmw6IHN0cmluZztcbiAgICBpZiAodGhpcy52aWV3ZXJPcHRpb25zLmluaXRpYWxpemVyT3B0aW9ucz8uZW52ID09PSAnTG9jYWwnKSB7XG4gICAgICB1cmwgPSB0aGlzLnZpZXdlck9wdGlvbnMuaW5pdGlhbGl6ZXJPcHRpb25zPy5kb2N1bWVudDtcbiAgICB9XG4gICAgLy8gU3RhcnQgdGhlIHZpZXdlclxuICAgIHRoaXMudmlld2VyLnN0YXJ0KHVybCk7XG5cbiAgICAvLyBWaWV3ZXIgaXMgcmVhZHkgLSBzY3JpcHRzIGFyZSBsb2FkZWQgYW5kIHdlJ3ZlIGNyZWF0ZSBhIG5ldyB2aWV3aW5nIGFwcGxpY2F0aW9uXG4gICAgdGhpcy52aWV3ZXJJbml0aWFsaXplZCA9IHRydWU7XG4gICAgdGhpcy52aWV3ZXJPcHRpb25zLm9uVmlld2VySW5pdGlhbGl6ZWQoeyB2aWV3ZXJDb21wb25lbnQ6IHRoaXMsIHZpZXdlcjogdGhpcy52aWV3ZXIgfSk7XG4gIH1cblxuICAvKipcbiAgICogTG9hZHMgYSBtb2RlbCBpbiB0byB0aGUgdmlld2VyIHZpYSBpdCdzIHVyblxuICAgKi9cbiAgcHJpdmF0ZSBsb2FkTW9kZWwoZG9jdW1lbnRJZDogc3RyaW5nKSB7XG4gICAgaWYgKCFkb2N1bWVudElkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gQWRkIHVybjogdG8gdGhlIGJlZ2lubmluZyBvZiBkb2N1bWVudCBpZCBpZiBuZWVkZWRcbiAgICBBdXRvZGVzay5WaWV3aW5nLkRvY3VtZW50LmxvYWQoVmlld2VyQ29tcG9uZW50LnZlcmlmeVVybihkb2N1bWVudElkKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkRvY3VtZW50TG9hZFN1Y2Nlc3MuYmluZCh0aGlzKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkRvY3VtZW50TG9hZEZhaWx1cmUuYmluZCh0aGlzKSk7XG4gIH1cblxuICAvKipcbiAgICogRG9jdW1lbnQgc3VjY2Vzc2Z1bGx5IGxvYWRlZFxuICAgKi9cbiAgcHJpdmF0ZSBvbkRvY3VtZW50TG9hZFN1Y2Nlc3MoZG9jdW1lbnQ6IEF1dG9kZXNrLlZpZXdpbmcuRG9jdW1lbnQpIHtcbiAgICBpZiAoIWRvY3VtZW50LmdldFJvb3QoKSkgcmV0dXJuO1xuXG4gICAgLy8gRW1pdCBhbiBldmVudCBzbyB0aGUgY2FsbGVyIGNhbiBkbyBzb21ldGhpbmdcbiAgICAvLyBUT0RPOiBjb25maWcgb3B0aW9uIHRvIHNwZWNpZnkgd2hpY2ggdmlld2FibGUgdG8gZGlzcGxheSAoaG93PylcbiAgICB0aGlzLm9uRG9jdW1lbnRDaGFuZ2VkLmVtaXQoeyBkb2N1bWVudCwgdmlld2VyQ29tcG9uZW50OiB0aGlzLCB2aWV3ZXI6IHRoaXMudmlld2VyIH0pO1xuXG4gICAgaWYgKHRoaXMudmlld2VyT3B0aW9ucy5zaG93Rmlyc3RWaWV3YWJsZSA9PT0gdW5kZWZpbmVkIHx8IHRoaXMudmlld2VyT3B0aW9ucy5zaG93Rmlyc3RWaWV3YWJsZSkge1xuICAgICAgbGV0IG1vZGVsOiBBdXRvZGVzay5WaWV3aW5nLkJ1YmJsZU5vZGUgPSAoZG9jdW1lbnQuZ2V0Um9vdCgpIGFzIGFueSkuZ2V0RGVmYXVsdEdlb21ldHJ5KCk7XG4gICAgICBpZiAoIW1vZGVsKSB7XG4gICAgICAgIGNvbnN0IGFsbE1vZGVscyA9IGRvY3VtZW50LmdldFJvb3QoKS5zZWFyY2goeyB0eXBlOiAnZ2VvbWV0cnknIH0pO1xuICAgICAgICBtb2RlbCA9IGFsbE1vZGVsc1swXTtcbiAgICAgIH1cblxuICAgICAgdm9pZCB0aGlzLnZpZXdlci5sb2FkRG9jdW1lbnROb2RlKGRvY3VtZW50LCBtb2RlbCwgdW5kZWZpbmVkKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRmFpbGVkIHRvIGxvYWQgZG9jdW1lbnRcbiAgICovXG4gIHByaXZhdGUgb25Eb2N1bWVudExvYWRGYWlsdXJlKGVycm9yQ29kZTogQXV0b2Rlc2suVmlld2luZy5FcnJvckNvZGVzKSB7XG4gICAgdGhpcy5lcnJvcignb25Eb2N1bWVudExvYWRGYWlsdXJlKCkgLSBlcnJvckNvZGU6JyArIGVycm9yQ29kZSk7XG4gICAgdGhpcy5vbkVycm9yLmVtaXQoZXJyb3JDb2RlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWdpc3RlciBvdXIgQmFzaWNFeHRlbnNpb24gd2l0aCB0aGUgRm9yZ2UgVmlld2VyXG4gICAqL1xuICBwcml2YXRlIHJlZ2lzdGVyQmFzaWNFeHRlbnNpb24oKTogc3RyaW5nIHtcbiAgICBCYXNpY0V4dGVuc2lvbi5yZWdpc3RlckV4dGVuc2lvbihCYXNpY0V4dGVuc2lvbi5leHRlbnNpb25OYW1lLCB0aGlzLmV4dGVuc2lvbkxvYWRlZC5iaW5kKHRoaXMpKTtcbiAgICByZXR1cm4gQmFzaWNFeHRlbnNpb24uZXh0ZW5zaW9uTmFtZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdWJzY3JpcHQgdG8gQmFzaWNFeHRlbnNpb24gZXZlbnRzIHdoZW4gdGhlIGV4dGVuc2lvbiBoYXMgYmVlblxuICAgKiBzdWNjZXNmdWxseSBsb2FkZWQgYnkgdGhlIHZpZXdlci5cbiAgICovXG4gIHByaXZhdGUgZXh0ZW5zaW9uTG9hZGVkKGV4dDogQmFzaWNFeHRlbnNpb24pIHtcbiAgICB0aGlzLmJhc2ljRXh0ID0gZXh0O1xuICAgIGV4dC52aWV3ZXJFdmVudHNcbiAgICAgIC5waXBlKHRha2VVbnRpbCh0aGlzLnVuc3Vic2NyaWJlKSlcbiAgICAgIC5zdWJzY3JpYmUoKGl0ZW06IFZpZXdlckV2ZW50QXJncykgPT4ge1xuICAgICAgICB0aGlzLmxvZyhpdGVtKTtcblxuICAgICAgICBpZiAoaXRlbSBpbnN0YW5jZW9mIEZpdFRvVmlld0V2ZW50QXJncykge1xuICAgICAgICAgIHRoaXMub25GaXRUb1ZpZXcuZW1pdChpdGVtKTtcbiAgICAgICAgfSBlbHNlIGlmIChpdGVtIGluc3RhbmNlb2YgRnVsbHNjcmVlbkV2ZW50QXJncykge1xuICAgICAgICAgIHRoaXMub25GdWxsc2NyZWVuLmVtaXQoaXRlbSk7XG4gICAgICAgIH0gZWxzZSBpZiAoaXRlbSBpbnN0YW5jZW9mIEdlb21ldHJ5TG9hZGVkRXZlbnRBcmdzKSB7XG4gICAgICAgICAgdGhpcy5vbkdlb21ldHJ5TG9hZGVkLmVtaXQoaXRlbSk7XG4gICAgICAgIH0gZWxzZSBpZiAoaXRlbSBpbnN0YW5jZW9mIEhpZGVFdmVudEFyZ3MpIHtcbiAgICAgICAgICB0aGlzLm9uSGlkZS5lbWl0KGl0ZW0pO1xuICAgICAgICB9IGVsc2UgaWYgKGl0ZW0gaW5zdGFuY2VvZiBJc29sYXRlRXZlbnRBcmdzKSB7XG4gICAgICAgICAgdGhpcy5vbklzb2xhdGUuZW1pdChpdGVtKTtcbiAgICAgICAgfSBlbHNlIGlmIChpdGVtIGluc3RhbmNlb2YgT2JqZWN0VHJlZUNyZWF0ZWRFdmVudEFyZ3MpIHtcbiAgICAgICAgICB0aGlzLm9uT2JqZWN0VHJlZUNyZWF0ZWQuZW1pdChpdGVtKTtcbiAgICAgICAgfSBlbHNlIGlmIChpdGVtIGluc3RhbmNlb2YgT2JqZWN0VHJlZVVuYXZhaWxhYmxlRXZlbnRBcmdzKSB7XG4gICAgICAgICAgdGhpcy5vbk9iamVjdFRyZWVVbmF2YWlsYWJsZS5lbWl0KGl0ZW0pO1xuICAgICAgICB9IGVsc2UgaWYgKGl0ZW0gaW5zdGFuY2VvZiBSZXNldEV2ZW50QXJncykge1xuICAgICAgICAgIHRoaXMub25SZXNldC5lbWl0KGl0ZW0pO1xuICAgICAgICB9IGVsc2UgaWYgKGl0ZW0gaW5zdGFuY2VvZiBTZWxlY3Rpb25DaGFuZ2VkRXZlbnRBcmdzKSB7XG4gICAgICAgICAgdGhpcy5vblNlbGVjdGlvbkNoYW5nZWQuZW1pdChpdGVtKTtcbiAgICAgICAgfSBlbHNlIGlmIChpdGVtIGluc3RhbmNlb2YgU2hvd0V2ZW50QXJncykge1xuICAgICAgICAgIHRoaXMub25TaG93LmVtaXQoaXRlbSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSB1bnJlZ2lzdGVyQmFzaWNFeHRlbnNpb24oKSB7XG4gICAgQmFzaWNFeHRlbnNpb24udW5yZWdpc3RlckV4dGVuc2lvbihCYXNpY0V4dGVuc2lvbi5leHRlbnNpb25OYW1lKTtcbiAgICB0aGlzLmJhc2ljRXh0ID0gbnVsbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgbGlzdCBvZiBleHRlbnNpb25zIHRvIHRoZSB2aWV3ZXIgY29uZmlnIHRoYXQgaGFzIGJlZW4gcHJvdmlkZWRcbiAgICogVGhlIGFsbG93cyB0aGUgdXNlciB0byByZWdpc3RlciB0aGVpciBvd24gZXh0ZW5zaW9ucy5cbiAgICovXG4gIHByaXZhdGUgYWRkQmFzaWNFeHRlbnNpb25Db25maWcoZXh0TmFtZTogc3RyaW5nKTogQXV0b2Rlc2suVmlld2luZy5WaWV3ZXJDb25maWcge1xuICAgIGNvbnN0IGNvbmZpZzogQXV0b2Rlc2suVmlld2luZy5WaWV3ZXJDb25maWcgPSBPYmplY3QuYXNzaWduKFxuICAgICAge30sXG4gICAgICB0aGlzLnZpZXdlck9wdGlvbnMudmlld2VyQ29uZmlnLFxuICAgICAgeyBleHRlbnNpb25zOiBbXSB9LFxuICAgICk7XG5cbiAgICAvLyBXZSB3aWxsIGFsd2F5cyBsb2FkIG91ciBiYXNpYyBleHRlbnNpb24gd2l0aCBhbnkgb3RoZXJzIHNwZWNpZmllZCBieSB0aGUgY2FsbGVyXG4gICAgaWYgKHRoaXMudmlld2VyT3B0aW9ucy52aWV3ZXJDb25maWcgJiYgdGhpcy52aWV3ZXJPcHRpb25zLnZpZXdlckNvbmZpZy5leHRlbnNpb25zKSB7XG4gICAgICBjb25maWcuZXh0ZW5zaW9ucyA9IFsuLi50aGlzLnZpZXdlck9wdGlvbnMudmlld2VyQ29uZmlnLmV4dGVuc2lvbnMsIGV4dE5hbWVdO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25maWcuZXh0ZW5zaW9ucyA9IFtleHROYW1lXTtcbiAgICB9XG5cbiAgICByZXR1cm4gY29uZmlnO1xuICB9XG5cbiAgcHJpdmF0ZSBsb2cobWVzc2FnZT86IGFueSwgLi4ub3B0aW9uYWxQYXJhbXM6IGFueVtdKSB7XG4gICAgaWYgKCF0aGlzLnNob3dEZWJ1Z01lc3NhZ2VzKSByZXR1cm47XG4gICAgY29uc29sZS5sb2cobWVzc2FnZSwgb3B0aW9uYWxQYXJhbXMpO1xuICB9XG5cbiAgcHJpdmF0ZSBlcnJvcihtZXNzYWdlPzogYW55LCAuLi5vcHRpb25hbFBhcmFtczogYW55W10pIHtcbiAgICBpZiAoIXRoaXMuc2hvd0RlYnVnTWVzc2FnZXMpIHJldHVybjtcbiAgICBjb25zb2xlLmVycm9yKG1lc3NhZ2UsIG9wdGlvbmFsUGFyYW1zKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0RGl2TmFtZSgpIHtcbiAgICBjb25zdCBTNCA9ICgpID0+IHtcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1iaXR3aXNlXG4gICAgICByZXR1cm4gKCgoMSArIE1hdGgucmFuZG9tKCkpICogMHgxMDAwMCkgfCAwKS50b1N0cmluZygxNikuc3Vic3RyaW5nKDEpO1xuICAgIH07XG5cbiAgICBjb25zdCBndWlkID0gKFM0KCkgKyBTNCgpICsgJy0nICsgUzQoKSArICctJyArIFM0KCkgKyAnLScgKyBTNCgpICsgJy0nICsgUzQoKSArIFM0KCkgKyBTNCgpKTtcbiAgICByZXR1cm4gYHZpZXdlcl8ke2d1aWR9YDtcbiAgfVxufVxuIl19